<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªô Tr√¨nh To√°n - STUDY ASSISTANT PRO</title>
    
    <!-- PWA Enhancements: Manifest and Theme Color -->
    <meta name="theme-color" content="#0D6EFD"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #F8F9FA;
            color: #343A40;
        }
        .nav-button {
            transition: all 0.3s ease;
        }
        .nav-button.active {
            background-color: #0D6EFD;
            color: white;
            box-shadow: 0 4px 14px 0 rgba(13, 110, 253, 0.39);
        }
        .nav-button:not(.active):hover {
            background-color: #E9ECEF;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.07);
        }
        .details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .details.open {
            max-height: 3500px; /* Increased height */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            height: auto;
            max-height: 450px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 2s linear infinite;
            display: none; /* Hidden by default */
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ai-output, .user-query {
            white-space: pre-wrap;
            background: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .user-query {
             background: #e0f2fe; /* Light blue for user queries */
             text-align: right;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">TO√ÅN H·ªåC L√Ä S·ª∞ TH·ªÇ D·ª§C C·ª¶A TR√ç TU·ªÜ - L√Ä THI CA C·ª¶A T∆Ø DUY</h1>
            <p class="mt-4 text-lg text-gray-600 max-w-3xl mx-auto">STUDY ASSISTANT PRO: Tr·ª£ l√Ω h·ªçc t·∫≠p th·∫•u hi·ªÉu v√† to√†n di·ªán.</p>
        </header>

        <nav id="main-nav" class="flex flex-wrap justify-center gap-2 md:gap-4 mb-10 bg-white p-3 rounded-xl shadow-sm sticky top-4 z-10">
            <button data-target="overview" class="nav-button active font-semibold py-2 px-4 rounded-lg">üöÄ T·ªïng quan</button>
            <button data-target="phase1" class="nav-button font-semibold py-2 px-4 rounded-lg">1Ô∏è‚É£ Gƒê 1: N·ªÅn t·∫£ng</button>
            <button data-target="phase2" class="nav-button font-semibold py-2 px-4 rounded-lg">2Ô∏è‚É£ Gƒê 2: Tr·ªçng t√¢m 12</button>
            <button data-target="phase3" class="nav-button font-semibold py-2 px-4 rounded-lg">3Ô∏è‚É£ Gƒê 3: TƒÉng t·ªëc</button>
            <button data-target="strategy" class="nav-button font-semibold py-2 px-4 rounded-lg">üí° Chi·∫øn l∆∞·ª£c & H·ªèi ƒê√°p v·ªõi AI</button>
        </nav>

        <main id="main-content">
            <!-- Section: Overview -->
            <section id="overview" class="content-section active">
                <div class="card p-6 md:p-8 mb-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">T·ªïng Quan & Ph√¢n T√≠ch ƒê·ªÅ Thi</h2>
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                        <div>
                             <h3 class="text-xl font-semibold text-gray-700 mb-3">C·∫•u tr√∫c ƒë·ªÅ thi THPT Qu·ªëc gia</h3>
                             <p class="text-gray-600 mb-4">
                                ƒê·ªÅ thi m√¥n To√°n (tham kh·∫£o 2024) g·ªìm 50 c√¢u tr·∫Øc nghi·ªám trong 90 ph√∫t. Tr·ªçng t√¢m l√† ki·∫øn th·ª©c l·ªõp 12 (90%) v√† l·ªõp 11 (10%). N·∫Øm v·ªØng c√¢u h·ªèi Nh·∫≠n bi·∫øt & Th√¥ng hi·ªÉu l√† ch√¨a kh√≥a ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm an to√†n.
                            </p>
                            <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg mb-4">
                                <p><strong class="font-semibold">L∆∞u √Ω cho k·ª≥ thi 2025:</strong> ƒê·ªÅ thi d·ª± ki·∫øn s·∫Ω tinh g·ªçn h∆°n, l√† l·ª£i th·∫ø ƒë·ªÉ t·∫≠p trung v√†o ki·∫øn th·ª©c c·ªët l√µi.</p>
                            </div>
                            <div class="flex justify-center my-4">
                                <button id="toggle-chart-view" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Xem ph√¢n b·ªï theo M·ª©c ƒë·ªô</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="exam-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card p-6 md:p-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">‚ú® L·∫≠p K·∫ø Ho·∫°ch H·ªçc T·∫≠p C√° Nh√¢n H√≥a</h2>
                    <p class="text-gray-600 mb-6">Nh·∫≠p c√°c ch·ªß ƒë·ªÅ b·∫°n y·∫øu nh·∫•t v√† th·ªùi gian h·ªçc m·ªói ng√†y. AI s·∫Ω t·∫°o ra m·ªôt l·ªãch tr√¨nh 4 tu·∫ßn t√πy ch·ªânh d√†nh ri√™ng cho b·∫°n.</p>
                    <div class="w-full text-left space-y-4">
                        <div>
                            <label for="weak-topics-input" class="block text-sm font-medium text-gray-700">C√°c ch·ªß ƒë·ªÅ b·∫°n c·∫£m th·∫•y y·∫øu nh·∫•t?</label>
                            <input type="text" id="weak-topics-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="VD: Logarit, H√¨nh h·ªçc kh√¥ng gian, T√≠ch ph√¢n">
                        </div>
                        <div>
                            <label for="daily-time-input" class="block text-sm font-medium text-gray-700">B·∫°n c√≥ th·ªÉ h·ªçc bao nhi√™u l√¢u m·ªói ng√†y?</label>
                            <input type="text" id="daily-time-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="VD: 60 ph√∫t, 1.5 ti·∫øng">
                        </div>
                        <button id="personal-planner-btn" class="mt-2 w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors flex items-center justify-center">
                            T·∫°o K·∫ø Ho·∫°ch 4 Tu·∫ßn Cho T√¥i ‚ú®<span class="loader"></span>
                        </button>
                        <div id="personal-planner-output" class="mt-2"></div>
                    </div>
                </div>
            </section>
            
            <section id="phase1" class="content-section">
                <div class="card p-6 md:p-8"><h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Giai ƒëo·∫°n 1: X√¢y D·ª±ng N·ªÅn t·∫£ng</h2><p class="text-gray-600 mb-6">ƒê√¢y l√† giai ƒëo·∫°n quan tr·ªçng nh·∫•t. H√£y b·∫Øt ƒë·∫ßu b·∫±ng vi·ªác √¥n t·∫≠p ki·∫øn th·ª©c c·ªët l√µi THCS, sau ƒë√≥ d√πng b√†i ki·ªÉm tra ch·∫©n ƒëo√°n ƒë·ªÉ x√°c ƒë·ªãnh l·ªó h·ªïng v√† cu·ªëi c√πng l√† chinh ph·ª•c ki·∫øn th·ª©c l·ªõp 11.</p><div id="phase1-topics" class="space-y-4"></div><div id="phase1-completion" class="mt-6"></div></div>
            </section>
            <section id="phase2" class="content-section">
                <div class="card p-6 md:p-8"><h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Giai ƒëo·∫°n 2: Tr·ªçng t√¢m 12</h2><p class="text-gray-600 mb-6">ƒê√¢y l√† giai ƒëo·∫°n tr·ªçng t√¢m, chi·∫øm 90% ƒë·ªÅ thi. H√£y ∆∞u ti√™n c√°c c√¢u h·ªèi ·ªü m·ª©c Nh·∫≠n bi·∫øt v√† Th√¥ng hi·ªÉu.</p><div id="phase2-topics" class="space-y-4"></div><div id="phase2-completion" class="mt-6"></div></div>
            </section>
            <section id="phase3" class="content-section">
                <div class="card p-6 md:p-8"><h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Giai ƒëo·∫°n 3: TƒÉng T·ªëc</h2><p class="text-gray-600 mb-6">Chuy·ªÉn t·ª´ h·ªçc ki·∫øn th·ª©c sang r√®n luy·ªán k·ªπ nƒÉng l√†m b√†i thi, √°p d·ª•ng ki·∫øn th·ª©c d∆∞·ªõi √°p l·ª±c th·ªùi gian.</p><div id="phase3-topics" class="space-y-4"></div><div id="phase3-completion" class="mt-6"></div></div>
            </section>

            <section id="strategy" class="content-section">
                 <div class="card p-6 md:p-8"><h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Chi·∫øn L∆∞·ª£c H·ªçc T·∫≠p & Tr·ª£ L√Ω AI</h2><p class="text-gray-600 mb-6">K·∫øt h·ª£p ph∆∞∆°ng ph√°p h·ªçc truy·ªÅn th·ªëng v·ªõi c√°c c√¥ng c·ª• AI th√¥ng minh ƒë·ªÉ t·ªëi ∆∞u h√≥a qu√° tr√¨nh √¥n luy·ªán.</p><div id="strategy-items" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
            </section>
        </main>
    </div>
    
    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js').then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, err => {
              console.log('ServiceWorker registration failed: ', err);
            });
          });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const allTopics = [
                'H√†m s·ªë v√† ƒê·∫°o h√†m', 'M≈© v√† Logarit', 'Nguy√™n h√†m v√† T√≠ch ph√¢n', 'S·ªë ph·ª©c', 
                'H√¨nh h·ªçc kh√¥ng gian', 'H√¨nh h·ªçc Oxyz', 'T·ªï h·ª£p v√† X√°c su·∫•t', 'C·∫•p s·ªë c·ªông, C·∫•p s·ªë nh√¢n'
            ];
            const data = {
                examTopics: { labels: ['·ª®ng d·ª•ng ƒë·∫°o h√†m', 'H√†m s·ªë m≈©, logarit', 'S·ªë ph·ª©c', 'Nguy√™n h√†m, t√≠ch ph√¢n', 'Kh·ªëi ƒëa di·ªán', 'Kh·ªëi tr√≤n xoay', 'H√¨nh h·ªçc Oxyz', 'ƒê·∫°i s·ªë t·ªï h·ª£p', 'Quan h·ªá vu√¥ng g√≥c'], data: [10, 8, 6, 6, 3, 3, 8, 4, 2]},
                examDifficulty: { labels: ['Nh·∫≠n bi·∫øt', 'Th√¥ng hi·ªÉu', 'V·∫≠n d·ª•ng', 'V·∫≠n d·ª•ng cao'], data: [20, 16, 8, 6]},
                phase1Topics: [
                    { title: 'üî¢ S·ªë h·ªçc & Bi·ªÉu th·ª©c (THCS)', details: ['C√°c ph√©p t√≠nh v·ªÅ ph√¢n s·ªë, l≈©y th·ª´a, cƒÉn b·∫≠c hai. Bi·∫øn ƒë·ªïi v√† r√∫t g·ªçn bi·ªÉu th·ª©c ƒë·∫°i s·ªë, h·∫±ng ƒë·∫≥ng th·ª©c ƒë√°ng nh·ªõ.'], topicType: 'thcs' },
                    { title: 'üü∞ Ph∆∞∆°ng tr√¨nh & H·ªá ph∆∞∆°ng tr√¨nh (THCS)', details: ['Gi·∫£i ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t, b·∫≠c hai (Delta, Vi-√©t). Gi·∫£i h·ªá hai ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n.'], topicType: 'thcs' },
                    { title: 'üìê H√¨nh h·ªçc ph·∫≥ng (THCS)', details: ['H·ªá th·ª©c l∆∞·ª£ng trong tam gi√°c vu√¥ng, t√≠nh ch·∫•t c√°c ƒë∆∞·ªùng trong tam gi√°c, t√≠nh ch·∫•t t·ª© gi√°c n·ªôi ti·∫øp v√† ƒë∆∞·ªùng tr√≤n.'], topicType: 'thcs' },
                    { title: 'ü©∫ B√†i Ki·ªÉm Tra Ch·∫©n ƒêo√°n NƒÉng L·ª±c', details: ['ƒê·ªÉ x√°c ƒë·ªãnh ch√≠nh x√°c nh·ªØng "l·ªó h·ªïng" ki·∫øn th·ª©c c·ªßa b·∫°n, h√£y b·∫Øt ƒë·∫ßu v·ªõi b√†i ki·ªÉm tra ch·∫©n ƒëo√°n do AI t·∫°o ra. AI s·∫Ω ƒë∆∞a ra m·ªôt s·ªë c√¢u h·ªèi t·ªïng h·ª£p, sau ƒë√≥ ph√¢n t√≠ch k·∫øt qu·∫£ ƒë·ªÉ ƒë·ªÅ xu·∫•t l·ªô tr√¨nh h·ªçc t·∫≠p ph√π h·ª£p nh·∫•t cho b·∫°n.'], specialFeature: 'diagnosticTest' },
                    { title: 'üß† C·ªßng c·ªë ki·∫øn th·ª©c l·ªõp 11 (10% ƒë·ªÅ thi)', details: ['<strong>T·ªï h·ª£p v√† X√°c su·∫•t:</strong> Quy t·∫Øc ƒë·∫øm, ho√°n v·ªã, ch·ªânh h·ª£p, t·ªï h·ª£p.', '<strong>C·∫•p s·ªë c·ªông, C·∫•p s·ªë nh√¢n:</strong> C√¥ng th·ª©c c∆° b·∫£n.', '<strong>H√¨nh h·ªçc kh√¥ng gian:</strong> Quan h·ªá song song v√† vu√¥ng g√≥c.'], topicType: 'standard' }
                ],
                phase2Topics: [
                    { title: 'üìà ·ª®ng d·ª•ng ƒë·∫°o h√†m ƒë·ªÉ kh·∫£o s√°t h√†m s·ªë', details: ['T√≠nh ƒë∆°n ƒëi·ªáu, c·ª±c tr·ªã, GTLN-GTNN, ti·ªám c·∫≠n, ƒë·ªì th·ªã.'], topicType: 'standard' },
                    { title: 'üìê H√†m s·ªë m≈© v√† Logarit', details: ['L√Ω thuy·∫øt l≈©y th·ª´a, ph∆∞∆°ng tr√¨nh v√† b·∫•t ph∆∞∆°ng tr√¨nh m≈©-logarit.'], topicType: 'standard' },
                    { title: '‚à´ Nguy√™n h√†m ‚Äì T√≠ch ph√¢n v√† ·ª©ng d·ª•ng', details: ['C√¥ng th·ª©c, ph∆∞∆°ng ph√°p, ·ª©ng d·ª•ng t√≠nh di·ªán t√≠ch, th·ªÉ t√≠ch.'], topicType: 'standard' },
                    { title: '‚ÑÇ S·ªë ph·ª©c', details: ['Ph√©p to√°n, module, bi·ªÉu di·ªÖn h√¨nh h·ªçc.'], topicType: 'standard' },
                    { title: 'üåê H√¨nh h·ªçc gi·∫£i t√≠ch trong kh√¥ng gian Oxyz', details: ['T·ªça ƒë·ªô, ph∆∞∆°ng tr√¨nh m·∫∑t ph·∫≥ng, ƒë∆∞·ªùng th·∫≥ng, m·∫∑t c·∫ßu.'], topicType: 'standard' },
                    { title: 'üßä Kh·ªëi ƒëa di·ªán v√† Kh·ªëi tr√≤n xoay', details: ['Th·ªÉ t√≠ch kh·ªëi ch√≥p, lƒÉng tr·ª•. Di·ªán t√≠ch, th·ªÉ t√≠ch kh·ªëi n√≥n, tr·ª•, c·∫ßu.'], topicType: 'standard' }
                ],
                phase3Topics: [
                     { title: '‚è±Ô∏è Luy·ªán ƒë·ªÅ t·ªïng h·ª£p', details: ['L√†m ƒë·ªÅ thi th·ª≠, ƒë·ªÅ c√°c nƒÉm tr∆∞·ªõc d∆∞·ªõi √°p l·ª±c th·ªùi gian th·∫≠t.'], topicType: 'standard' },
                     { title: '‚ö° Ho√†n thi·ªán k·ªπ nƒÉng l√†m b√†i', details: ['Chi·∫øn l∆∞·ª£c ph√¢n b·ªï th·ªùi gian, k·ªπ thu·∫≠t l√†m tr·∫Øc nghi·ªám.'], topicType: 'standard' }
                ],
                strategyItems: [
                    { icon: '‚ù§Ô∏è‚Äçü©π', title: 'L√™n D√¢y C√≥t Tinh Th·∫ßn', description: 'C·∫£m th·∫•y n·∫£n l√≤ng? AI s·∫Ω ·ªü ƒë√¢y ƒë·ªÉ ƒë·ªông vi√™n v√† gi√∫p b·∫°n l·∫•y l·∫°i tinh th·∫ßn chi·∫øn ƒë·∫•u!', specialFeature: 'motivationalTalk' },
                    { icon: 'üîó', title: 'K·∫øt N·ªëi C√°c Ch·ªß ƒê·ªÅ', description: 'Kh√°m ph√° m·ªëi li√™n h·ªá ·∫©n sau c√°c ch·ªß ƒë·ªÅ To√°n h·ªçc ƒë·ªÉ c√≥ c√°i nh√¨n s√¢u s·∫Øc h∆°n.', specialFeature: 'connectTopics' },
                    { icon: 'üìâ', title: 'Ph√¢n T√≠ch M·∫´u L·ªói Sai', description: 'M√¥ t·∫£ nh·ªØng l·ªói sai b·∫°n th∆∞·ªùng g·∫∑p, AI s·∫Ω ph√¢n t√≠ch m·∫´u l·ªói v√† ƒë∆∞a ra l·ªùi khuy√™n chi·∫øn l∆∞·ª£c ƒë·ªÉ kh·∫Øc ph·ª•c.', specialFeature: 'analyzeMistakePattern' },
                    { icon: 'üìñ', title: 'S·ªï Tay C√¥ng Th·ª©c Th√¥ng Minh', description: 'Tra c·ª©u nhanh c√¥ng th·ª©c, ƒë·ªãnh nghƒ©a v√† v√≠ d·ª• cho m·ªçi ch·ªß ƒë·ªÅ quan tr·ªçng.', specialFeature: 'formulaHandbook' },
                    { icon: 'ü§ñ', title: 'Gia s∆∞ AI 24/7', description: 'ƒê·∫∑t b·∫•t k·ª≥ c√¢u h·ªèi To√°n n√†o v√† nh·∫≠n c√¢u tr·∫£ l·ªùi ngay l·∫≠p t·ª©c!', specialFeature: 'aiTutor' }
                ],
                formulaTopics: allTopics
            };

            // --- NAVIGATION ---
            const navButtons = document.querySelectorAll('#main-nav button');
            function switchTab(targetId) {
                document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');
                navButtons.forEach(button => button.classList.toggle('active', button.dataset.target === targetId));
            }
            navButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.target)));

            // --- GEMINI API CALLER (Robust version) ---
            async function callGemini(prompt, conversationContainer, context) {
                const apiKey = "AIzaSyAVUW36IOWj45U1Y69w5NH69VJ_9J8CGvQ";

                if (apiKey === "YOUR_GOOGLE_AI_STUDIO_API_KEY" || !apiKey) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'ai-output';
                    errorDiv.style.color = 'red';
                    errorDiv.innerHTML = `<strong>L·ªói C·∫•u H√¨nh:</strong><br>B·∫°n ch∆∞a th√™m API Key. Vui l√≤ng:<br>1. L·∫•y API Key t·ª´ Google AI Studio.<br>2. M·ªü file <strong>index.html</strong>, t√¨m d√≤ng <strong>const apiKey = "..."</strong><br>3. D√°n API Key c·ªßa b·∫°n v√†o gi·ªØa d·∫•u ngo·∫∑c k√©p.`;
                    conversationContainer.innerHTML = ''; 
                    conversationContainer.appendChild(errorDiv);
                    return; 
                }

                let loader = conversationContainer.querySelector('.loader');
                if (!loader) {
                    loader = document.createElement('div');
                    loader.className = 'loader';
                    conversationContainer.appendChild(loader);
                }
                loader.style.display = 'inline-block';
                conversationContainer.scrollTop = conversationContainer.scrollHeight;

                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `L·ªói HTTP: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    loader.remove();
                    
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content?.parts?.[0]?.text) {
                        const aiResponseDiv = document.createElement('div');
                        aiResponseDiv.className = 'ai-output';
                        aiResponseDiv.textContent = result.candidates[0].content.parts[0].text;
                        conversationContainer.appendChild(aiResponseDiv);
                        
                        if (context && context.specialFeature === 'diagnosticTest_results') {
                             // Do not add follow up for test results to keep it clean
                        } else if(context && context.conceptTitle) {
                           addFollowUpUI(conversationContainer, context);
                        }
                    } else if (result.candidates && result.candidates[0].finishReason === 'SAFETY') {
                        throw new Error('Ph·∫£n h·ªìi b·ªã ch·∫∑n v√¨ l√Ω do an to√†n. Vui l√≤ng ƒëi·ªÅu ch·ªânh c√¢u h·ªèi.');
                    } else {
                        console.error('Invalid or empty response structure:', result);
                        throw new Error('ƒê·ªãnh d·∫°ng ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá ho·∫∑c r·ªóng.');
                    }
                } catch (error) {
                    console.error('L·ªói khi g·ªçi API Gemini:', error);
                    loader.remove();
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'ai-output';
                    errorDiv.style.color = 'red';
                    errorDiv.textContent = `ƒê√£ x·∫£y ra l·ªói: ${error.message}.`;
                    conversationContainer.appendChild(errorDiv);
                } finally {
                     conversationContainer.scrollTop = conversationContainer.scrollHeight;
                }
            }
            
            // --- FOLLOW-UP UI ---
            function addFollowUpUI(container, context) {
                const existingForm = container.querySelector('.follow-up-form');
                if (existingForm) {
                    existingForm.remove();
                }

                const form = document.createElement('div');
                form.className = 'follow-up-form mt-4';
                
                const textarea = document.createElement('textarea');
                textarea.rows = 2;
                textarea.className = 'w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500';
                textarea.placeholder = `H·ªèi th√™m v·ªÅ "${context.conceptTitle}"...`;
                
                const button = document.createElement('button');
                button.className = 'mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors flex items-center justify-center';
                button.innerHTML = `H·ªèi ti·∫øp ‚ú®<span class="loader"></span>`;
                
                form.appendChild(textarea);
                form.appendChild(button);
                container.appendChild(form);

                button.addEventListener('click', (e) => {
                    const followUpQuestion = textarea.value.trim();
                    if (!followUpQuestion) return;
                    
                    const userQueryDiv = document.createElement('div');
                    userQueryDiv.className = 'user-query';
                    userQueryDiv.textContent = followUpQuestion;
                    container.insertBefore(userQueryDiv, form);

                    const newPrompt = `Trong b·ªëi c·∫£nh th·∫£o lu·∫≠n v·ªÅ ch·ªß ƒë·ªÅ "${context.conceptTitle}", ng∆∞·ªùi d√πng c√≥ c√¢u h·ªèi ti·∫øp theo: "${followUpQuestion}". H√£y tr·∫£ l·ªùi c√¢u h·ªèi n√†y.`;
                    
                    form.remove();
                    
                    callGemini(newPrompt, container, context);
                });
            }

            // --- UI ELEMENT CREATION ---
            function createTopicItem(topic) {
                const item = document.createElement('div');
                item.className = 'card p-5';

                // Handle special features like the diagnostic test
                if (topic.specialFeature === 'diagnosticTest') {
                    item.innerHTML = `
                        <div class="font-semibold text-lg text-gray-800 cursor-pointer">${topic.title}</div>
                        <div class="details text-gray-600 mt-2 space-y-1 pl-4 border-l-2 border-gray-200">
                            <p>${topic.details[0]}</p>
                            <div class="diagnostic-container mt-4">
                                <button class="start-diagnostic-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">B·∫Øt ƒë·∫ßu Ki·ªÉm tra Ch·∫©n ƒëo√°n ‚ú®</button>
                                <div class="conversation-container mt-2"></div>
                            </div>
                        </div>`;

                    const detailsContainer = item.querySelector('.details');
                    const conversationContainer = item.querySelector('.conversation-container');
                    
                    item.querySelector('.font-semibold').addEventListener('click', () => detailsContainer.classList.toggle('open'));

                    item.querySelector('.start-diagnostic-btn').addEventListener('click', e => {
                        e.currentTarget.style.display = 'none';
                        const prompt = `V·ªõi vai tr√≤ l√† m·ªôt gia s∆∞ AI, h√£y t·∫°o m·ªôt b√†i ki·ªÉm tra ch·∫©n ƒëo√°n nƒÉng l·ª±c g·ªìm 8 c√¢u h·ªèi tr·∫Øc nghi·ªám t·ªïng h·ª£p ki·∫øn th·ª©c c·ªët l√µi t·ª´ l·ªõp 6-10. C√°c c√¢u h·ªèi c·∫ßn bao g·ªìm: 2 c√¢u v·ªÅ s·ªë h·ªçc (ph√¢n s·ªë, l≈©y th·ª´a), 2 c√¢u v·ªÅ ƒë·∫°i s·ªë (ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t/hai), 2 c√¢u v·ªÅ h√¨nh h·ªçc ph·∫≥ng (t√≠nh ch·∫•t, di·ªán t√≠ch), v√† 2 c√¢u v·ªÅ ki·∫øn th·ª©c l·ªõp 10 (vect∆°, l∆∞·ª£ng gi√°c c∆° b·∫£n). Sau khi ƒë∆∞a ra ƒë·ªÅ, h√£y h∆∞·ªõng d·∫´n ng∆∞·ªùi d√πng t·ª± l√†m b√†i v√† sau ƒë√≥ m√¥ t·∫£ l·∫°i nh·ªØng c√¢u h·ªç l√†m sai ho·∫∑c kh√¥ng ch·∫Øc ch·∫Øn ƒë·ªÉ AI ph√¢n t√≠ch.`;
                        callGemini(prompt, conversationContainer, {}).then(() => {
                            addDiagnosticAnalysisUI(conversationContainer);
                        });
                    });

                } else if (topic.topicType === 'thcs') { // Handle THCS topics
                     item.innerHTML = `
                        <div class="font-semibold text-lg text-gray-800 cursor-pointer">${topic.title}</div>
                        <div class="details text-gray-600 mt-2 space-y-1 pl-4 border-l-2 border-gray-200">
                            <p>${topic.details[0]}</p>
                            <div class="initial-buttons flex flex-wrap gap-2 mt-4 text-xs">
                                <button data-prompt-type="summary" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-2 rounded-md flex items-center">T√≥m t·∫Øt c·ªët l√µi ‚ú®</button>
                                <button data-prompt-type="cheatsheet" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded-md flex items-center">C√¥ng th·ª©c c·∫ßn nh·ªõ ‚ú®</button>
                                <button data-prompt-type="application" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-1 px-2 rounded-md flex items-center">·ª®ng d·ª•ng Th·ª±c t·∫ø ‚ú®</button>
                            </div>
                            <div class="conversation-container mt-2" style="max-height: 500px; overflow-y: auto;"></div>
                        </div>
                    `;
                    item.querySelector('.font-semibold').addEventListener('click', () => item.querySelector('.details').classList.toggle('open'));
                
                    const conversationContainer = item.querySelector('.conversation-container');
                    const conceptTitle = topic.title.replace(/\s*\(THCS\)/i, ''); // Clean title for prompt
                    const initialButtons = item.querySelector('.initial-buttons');

                    initialButtons.querySelectorAll('button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            conversationContainer.innerHTML = '';
                            initialButtons.style.display = 'none';

                            const promptType = e.currentTarget.dataset.promptType;
                            let initialPrompt = '';
                            switch(promptType) {
                                case 'summary': initialPrompt = `H√£y t√≥m t·∫Øt nh·ªØng ki·∫øn th·ª©c c·ªët l√µi nh·∫•t v·ªÅ ch·ªß ƒë·ªÅ '${conceptTitle}' c·ªßa ch∆∞∆°ng tr√¨nh THCS m√† h·ªçc sinh b·∫Øt bu·ªôc ph·∫£i n·∫Øm v·ªØng ƒë·ªÉ thi THPT Qu·ªëc gia.`; break;
                                case 'cheatsheet': initialPrompt = `Li·ªát k√™ c√°c c√¥ng th·ª©c quan tr·ªçng nh·∫•t v·ªÅ '${conceptTitle}' ·ªü b·∫≠c THCS d∆∞·ªõi d·∫°ng m·ªôt b·∫£ng "cheatsheet" ng·∫Øn g·ªçn, d·ªÖ nh·ªõ.`; break;
                                case 'application': initialPrompt = `V·ªõi vai tr√≤ l√† m·ªôt ng∆∞·ªùi truy·ªÅn c·∫£m h·ª©ng h·ªçc To√°n, h√£y gi·∫£i th√≠ch c√°ch ch·ªß ƒë·ªÅ '${conceptTitle}' ƒë∆∞·ª£c √°p d·ª•ng trong ƒë·ªùi s·ªëng th·ª±c t·∫ø (v√≠ d·ª•: t√†i ch√≠nh c√° nh√¢n, v·∫≠t l√Ω), c√¥ng ngh·ªá (v√≠ d·ª•: l·∫≠p tr√¨nh, ƒë·ªì h·ªça m√°y t√≠nh), ho·∫∑c c√°c lƒ©nh v·ª±c khoa h·ªçc kh√°c. H√£y ƒë∆∞a ra c√°c v√≠ d·ª• c·ª• th·ªÉ, th√∫ v·ªã ƒë·ªÉ h·ªçc sinh th·∫•y ƒë∆∞·ª£c √Ω nghƒ©a v√† t·∫ßm quan tr·ªçng c·ªßa m√¥n To√°n.`; break;
                            }
                            if(initialPrompt) {
                                callGemini(initialPrompt, conversationContainer, { conceptTitle });
                            }
                        });
                    });

                    item.querySelector('.font-semibold').addEventListener('click', () => {
                        if (!item.querySelector('.details').classList.contains('open')) {
                            initialButtons.style.display = 'flex';
                        }
                    });

                } else { // Standard topic items
                    item.innerHTML = `
                        <div class="font-semibold text-lg text-gray-800 cursor-pointer">${topic.title}</div>
                        <div class="details text-gray-600 mt-2 space-y-1 pl-4 border-l-2 border-gray-200">
                            ${topic.details.map(d => `<p>${d}</p>`).join('')}
                            <div class="initial-buttons flex flex-wrap gap-2 mt-4 text-xs">
                                <button data-prompt-type="explain" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-2 rounded-md flex items-center">Gi·∫£i th√≠ch ‚ú®</button>
                                <button data-prompt-type="mindmap" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded-md flex items-center">S∆° ƒë·ªì t∆∞ duy ‚ú®</button>
                                <button data-prompt-type="application" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-1 px-2 rounded-md flex items-center">·ª®ng d·ª•ng Th·ª±c t·∫ø ‚ú®</button>
                                <button data-prompt-type="mistake" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded-md flex items-center">D·ª± ƒëo√°n l·ªói sai ‚ú®</button>
                                <button data-prompt-type="quiz" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-1 px-2 rounded-md flex items-center">Ki·ªÉm tra nh·ªè ‚ú®</button>
                            </div>
                            <div class="conversation-container mt-2" style="max-height: 500px; overflow-y: auto;"></div>
                        </div>
                    `;

                    item.querySelector('.font-semibold').addEventListener('click', () => item.querySelector('.details').classList.toggle('open'));
                
                    const conversationContainer = item.querySelector('.conversation-container');
                    const conceptTitle = topic.title.replace(/<[^>]*>/g, '');
                    const initialButtons = item.querySelector('.initial-buttons');

                    initialButtons.querySelectorAll('button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            conversationContainer.innerHTML = '';
                            initialButtons.style.display = 'none';

                            const promptType = e.currentTarget.dataset.promptType;
                            let initialPrompt = '';
                            switch(promptType) {
                                case 'explain': initialPrompt = `V·ªõi vai tr√≤ l√† m·ªôt gia s∆∞ To√°n, h√£y gi·∫£i th√≠ch kh√°i ni·ªám '${conceptTitle}' m·ªôt c√°ch ƒë∆°n gi·∫£n, d·ªÖ hi·ªÉu nh·∫•t cho h·ªçc sinh m·∫•t g·ªëc.`; break;
                                case 'mindmap': initialPrompt = `V·ªõi vai tr√≤ l√† m·ªôt chuy√™n gia v·ªÅ ph∆∞∆°ng ph√°p h·ªçc t·∫≠p tr·ª±c quan, h√£y t·∫°o m·ªôt S∆° ƒë·ªì t∆∞ duy (mind map) b·∫±ng vƒÉn b·∫£n cho ch·ªß ƒë·ªÅ to√°n h·ªçc '${conceptTitle}'.`; break;
                                case 'application': initialPrompt = `V·ªõi vai tr√≤ l√† m·ªôt ng∆∞·ªùi truy·ªÅn c·∫£m h·ª©ng h·ªçc To√°n, h√£y gi·∫£i th√≠ch c√°ch ch·ªß ƒë·ªÅ '${conceptTitle}' ƒë∆∞·ª£c √°p d·ª•ng trong ƒë·ªùi s·ªëng th·ª±c t·∫ø (v√≠ d·ª•: t√†i ch√≠nh c√° nh√¢n, v·∫≠t l√Ω), c√¥ng ngh·ªá (v√≠ d·ª•: l·∫≠p tr√¨nh, ƒë·ªì h·ªça m√°y t√≠nh), ho·∫∑c c√°c lƒ©nh v·ª±c khoa h·ªçc kh√°c. H√£y ƒë∆∞a ra c√°c v√≠ d·ª• c·ª• th·ªÉ, th√∫ v·ªã ƒë·ªÉ h·ªçc sinh th·∫•y ƒë∆∞·ª£c √Ω nghƒ©a v√† t·∫ßm quan tr·ªçng c·ªßa m√¥n To√°n.`; break;
                                case 'mistake': initialPrompt = `V·ªõi vai tr√≤ l√† m·ªôt gia s∆∞ To√°n kinh nghi·ªám, h√£y li·ªát k√™ 3-4 l·ªói sai ph·ªï bi·∫øn nh·∫•t m√† h·ªçc sinh th∆∞·ªùng m·∫Øc ph·∫£i khi h·ªçc ch·ªß ƒë·ªÅ '${conceptTitle}' v√† c√°ch ph√≤ng tr√°nh.`; break;
                                case 'quiz': initialPrompt = `V·ªõi vai tr√≤ l√† m·ªôt gia s∆∞ To√°n, h√£y t·∫°o m·ªôt b√†i ki·ªÉm tra nh·ªè g·ªìm 5 c√¢u h·ªèi tr·∫Øc nghi·ªám v·ªÅ ch·ªß ƒë·ªÅ '${conceptTitle}' v·ªõi ƒë√°p √°n v√† gi·∫£i th√≠ch.`; break;
                            }
                            if(initialPrompt) {
                                callGemini(initialPrompt, conversationContainer, { conceptTitle });
                            }
                        });
                    });
                
                    item.querySelector('.font-semibold').addEventListener('click', () => {
                        if (!item.querySelector('.details').classList.contains('open')) {
                            initialButtons.style.display = 'flex';
                        }
                    });
                }
                return item;
            }
            
            function addDiagnosticAnalysisUI(container) {
                const form = document.createElement('div');
                form.className = 'diagnostic-analysis-form mt-4 p-4 border-t border-dashed';
                
                const label = document.createElement('label');
                label.for = 'diagnostic-results';
                label.className = 'block text-sm font-medium text-gray-700 mb-2';
                label.textContent = 'Sau khi l√†m b√†i, h√£y m√¥ t·∫£ nh·ªØng c√¢u b·∫°n l√†m sai ho·∫∑c kh√¥ng ch·∫Øc ch·∫Øn v√†o ƒë√¢y:';
                
                const textarea = document.createElement('textarea');
                textarea.id = 'diagnostic-results';
                textarea.rows = 3;
                textarea.className = 'w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500';
                textarea.placeholder = 'V√≠ d·ª•: Em l√†m sai c√¢u 2 v√† 5. C√¢u 7 em kh√¥ng bi·∫øt c√°ch l√†m...';
                
                const button = document.createElement('button');
                button.className = 'mt-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors flex items-center justify-center';
                button.innerHTML = `Ch·∫©n ƒëo√°n v√† ƒë∆∞a ra L·ªô tr√¨nh h·ªçc ‚ú®<span class="loader"></span>`;
                
                form.appendChild(label);
                form.appendChild(textarea);
                form.appendChild(button);
                container.appendChild(form);

                button.addEventListener('click', () => {
                    const userFeedback = textarea.value.trim();
                    if (!userFeedback) return;

                    const userFeedbackDiv = document.createElement('div');
                    userFeedbackDiv.className = 'user-query';
                    userFeedbackDiv.textContent = `Ph·∫£n h·ªìi c·ªßa em: ${userFeedback}`;
                    container.insertBefore(userFeedbackDiv, form);

                    const analysisPrompt = `D·ª±a tr√™n b√†i ki·ªÉm tra ch·∫©n ƒëo√°n nƒÉng l·ª±c v·ª´a t·∫°o v√† ph·∫£n h·ªìi c·ªßa h·ªçc sinh: "${userFeedback}", h√£y ƒë√≥ng vai m·ªôt gia s∆∞ AI gi√†u kinh nghi·ªám ƒë·ªÉ:
1.  **Ch·∫©n ƒëo√°n:** Ph√¢n t√≠ch v√† ch·ªâ ra nh·ªØng "l·ªó h·ªïng" ki·∫øn th·ª©c c·ª• th·ªÉ c·ªßa h·ªçc sinh.
2.  **ƒê·ªÅ xu·∫•t L·ªô tr√¨nh:** ƒê∆∞a ra m·ªôt k·∫ø ho·∫°ch h√†nh ƒë·ªông ng·∫Øn g·ªçn, ∆∞u ti√™n c√°c ch·ªß ƒë·ªÅ c·∫ßn √¥n t·∫≠p tr∆∞·ªõc ƒë·ªÉ l·∫•p ƒë·∫ßy nh·ªØng l·ªó h·ªïng ƒë√≥.
3.  **ƒê·ªông vi√™n:** ƒê∆∞a ra l·ªùi kh√≠ch l·ªá ƒë·ªÉ h·ªçc sinh c·∫£m th·∫•y t·ª± tin b·∫Øt ƒë·∫ßu.`;
                    
                    form.remove();
                    callGemini(analysisPrompt, container, { specialFeature: 'diagnosticTest_results' });
                });
            }


            function createStrategyItem(item) {
                const card = document.createElement('div');
                card.className = 'card p-6 flex flex-col items-center text-center';
                let content = '';
                switch (item.specialFeature) {
                    case 'motivationalTalk':
                        card.className += ' md:col-span-2 lg:col-span-3';
                        content = `<div class="text-4xl mb-3">${item.icon}</div><h4 class="font-bold text-lg text-gray-800 mb-2">${item.title}</h4><p class="text-gray-600 text-sm mb-4">${item.description}</p>
                            <div class="w-full text-left space-y-3">
                                <label for="mood-selector" class="block text-sm font-medium text-gray-700">T√¢m tr·∫°ng c·ªßa b·∫°n l√∫c n√†y?</label>
                                <select id="mood-selector" class="w-full p-2 border border-gray-300 rounded-md mt-1">
                                    <option value="N·∫£n l√≤ng">N·∫£n l√≤ng</option>
                                    <option value="CƒÉng th·∫≥ng">CƒÉng th·∫≥ng</option>
                                    <option value="M·∫•t ph∆∞∆°ng h∆∞·ªõng">M·∫•t ph∆∞∆°ng h∆∞·ªõng</option>
                                    <option value="M·ªát m·ªèi">M·ªát m·ªèi</option>
                                </select>
                                <button class="pep-talk-btn w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">Ti·∫øp th√™m ƒë·ªông l·ª±c cho t√¥i ‚ú®<span class="loader"></span></button>
                                <div class="pep-talk-output mt-2"></div>
                            </div>`;
                        break;
                    case 'connectTopics':
                        card.className += ' md:col-span-2 lg:col-span-3';
                        content = `<div class="text-4xl mb-3">${item.icon}</div><h4 class="font-bold text-lg text-gray-800 mb-2">${item.title}</h4><p class="text-gray-600 text-sm mb-4">${item.description}</p>
                            <div class="w-full text-left space-y-3">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="topic1" class="block text-sm font-medium text-gray-700">Ch·ªß ƒë·ªÅ 1:</label><select id="topic1" class="w-full p-2 border border-gray-300 rounded-md mt-1">${allTopics.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                                    <div><label for="topic2" class="block text-sm font-medium text-gray-700">Ch·ªß ƒë·ªÅ 2:</label><select id="topic2" class="w-full p-2 border border-gray-300 rounded-md mt-1">${allTopics.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                                </div>
                                <button class="connect-topics-btn w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">Kh√°m Ph√° M·ªëi Li√™n H·ªá ‚ú®<span class="loader"></span></button>
                                <div class="connect-topics-output mt-2"></div>
                            </div>`;
                        break;
                    case 'analyzeMistakePattern':
                        card.className += ' md:col-span-2 lg:col-span-3';
                        content = `<div class="text-4xl mb-3">${item.icon}</div><h4 class="font-bold text-lg text-gray-800 mb-2">${item.title}</h4><p class="text-gray-600 text-sm mb-4">${item.description}</p>
                            <div class="w-full text-left space-y-3">
                                <textarea id="mistake-pattern-input" rows="4" class="w-full p-2 border border-gray-300 rounded-md" placeholder="VD: Em hay qu√™n ƒë·ªïi d·∫•u khi chuy·ªÉn v·∫ø, th∆∞·ªùng t√≠nh sai c√°c b√†i logarit c√≥ c∆° s·ªë kh√°c nhau..."></textarea>
                                <button class="mistake-pattern-btn w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">Ph√¢n T√≠ch Gi√∫p T√¥i ‚ú®<span class="loader"></span></button>
                                <div class="mistake-pattern-output mt-2"></div>
                            </div>`;
                        break;
                    case 'formulaHandbook':
                        card.className += ' md:col-span-2 lg:col-span-3';
                        content = `<div class="text-4xl mb-3">${item.icon}</div><h4 class="font-bold text-lg text-gray-800 mb-2">${item.title}</h4><p class="text-gray-600 text-sm mb-4">${item.description}</p>
                            <div class="w-full text-left space-y-3">
                                <select id="formula-topic" class="w-full p-2 border border-gray-300 rounded-md">${data.formulaTopics.map(topic => `<option value="${topic}">${topic}</option>`).join('')}</select>
                                <button class="formula-btn w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">Tra C·ª©u Ngay ‚ú®<span class="loader"></span></button>
                                <div class="formula-output mt-2"></div>
                            </div>`;
                        break;
                    case 'aiTutor':
                        card.className += ' md:col-span-2 lg:col-span-3';
                        content = `<div class="text-4xl mb-3">${item.icon}</div><h4 class="font-bold text-lg text-gray-800 mb-2">${item.title}</h4><p class="text-gray-600 text-sm mb-4">${item.description}</p>
                            <div class="w-full text-left">
                                <textarea id="ai-tutor-input" rows="3" class="w-full p-2 border border-gray-300 rounded-md" placeholder="V√≠ d·ª•: 'Gi·∫£i th√≠ch gi√∫p em ƒë·ªãnh l√Ω Vi-√©t'"></textarea>
                                <button id="ai-tutor-btn" class="mt-2 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">H·ªèi Gia s∆∞ AI ‚ú®<span class="loader"></span></button>
                                <div id="ai-tutor-output" class="mt-2"></div>
                            </div>`;
                        break;
                    default:
                         content = `<div class="text-4xl mb-3">${item.icon}</div><h4 class="font-bold text-lg text-gray-800 mb-2">${item.title}</h4><p class="text-gray-600 text-sm">${item.description}</p>`;
                         break;
                }
                card.innerHTML = content;
                
                card.querySelector('.pep-talk-btn')?.addEventListener('click', e => {
                    const mood = card.querySelector('#mood-selector').value;
                    const outputEl = card.querySelector('.pep-talk-output');
                    const prompt = `V·ªõi vai tr√≤ l√† m·ªôt ng∆∞·ªùi b·∫°n ƒë·ªìng h√†nh th·∫•u hi·ªÉu v√† m·ªôt chuy√™n gia t√¢m l√Ω h·ªçc ƒë∆∞·ªùng, h√£y vi·∫øt m·ªôt l·ªùi ƒë·ªông vi√™n ch√¢n th√†nh cho m·ªôt h·ªçc sinh ƒëang c·∫£m th·∫•y '${mood}' khi h·ªçc m√¥n To√°n.`;
                    callGemini(prompt, outputEl, {});
                });

                card.querySelector('.connect-topics-btn')?.addEventListener('click', e => {
                    const topic1 = card.querySelector('#topic1').value;
                    const topic2 = card.querySelector('#topic2').value;
                    const outputEl = card.querySelector('.connect-topics-output');
                    if (topic1 === topic2) { outputEl.innerHTML = `<p class="text-sm text-yellow-600 mt-3">Vui l√≤ng ch·ªçn hai ch·ªß ƒë·ªÅ kh√°c nhau.</p>`; return; }
                    const prompt = `V·ªõi vai tr√≤ l√† m·ªôt nh√† to√°n h·ªçc, h√£y gi·∫£i th√≠ch m·ªëi li√™n h·ªá s√¢u s·∫Øc gi·ªØa hai ch·ªß ƒë·ªÅ to√°n h·ªçc: '${topic1}' v√† '${topic2}'.`;
                    callGemini(prompt, outputEl, {});
                });

                card.querySelector('.mistake-pattern-btn')?.addEventListener('click', e => {
                    const input = card.querySelector('#mistake-pattern-input').value;
                    const outputEl = card.querySelector('.mistake-pattern-output');
                    if (!input.trim()) { outputEl.innerHTML = `<p class="text-sm text-yellow-600 mt-3">Vui l√≤ng m√¥ t·∫£ l·ªói sai c·ªßa b·∫°n.</p>`; return; }
                    const prompt = `V·ªõi vai tr√≤ l√† m·ªôt gia s∆∞ To√°n kinh nghi·ªám, h√£y ph√¢n t√≠ch c√°c m·∫´u l·ªói sai t·ª´ m√¥ t·∫£ c·ªßa h·ªçc sinh: "${input}".`;
                    callGemini(prompt, outputEl, {});
                });
                card.querySelector('.formula-btn')?.addEventListener('click', e => {
                    const topic = card.querySelector('#formula-topic').value;
                    const outputEl = card.querySelector('.formula-output');
                    const prompt = `V·ªõi vai tr√≤ gia s∆∞ To√°n, h√£y li·ªát k√™ v√† gi·∫£i th√≠ch c√°c c√¥ng th·ª©c quan tr·ªçng nh·∫•t trong ch·ªß ƒë·ªÅ '${topic}'.`;
                    callGemini(prompt, outputEl, {});
                });
                card.querySelector('#ai-tutor-btn')?.addEventListener('click', e => {
                     const input = card.querySelector('#ai-tutor-input').value;
                     const outputEl = card.querySelector('#ai-tutor-output');
                     if (!input.trim()) { outputEl.innerHTML = `<p class="text-sm text-yellow-600 mt-3">Vui l√≤ng nh·∫≠p c√¢u h·ªèi.</p>`; return; }
                     const prompt = `V·ªõi vai tr√≤ gia s∆∞ To√°n th√¢n thi·ªán, h√£y tr·∫£ l·ªùi c√¢u h·ªèi c·ªßa h·ªçc sinh: "${input}"`;
                     callGemini(prompt, outputEl, {});
                });

                return card;
            }

            function createCompletionSection(phaseNum, phaseName) {
                const container = document.getElementById(`phase${phaseNum}-completion`);
                container.innerHTML = `
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <button class="complete-phase-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mx-auto">
                            T√¥i ƒë√£ ho√†n th√†nh ${phaseName}! ‚ú®<span class="loader"></span>
                        </button>
                        <div class="completion-output mt-2"></div>
                    </div>
                `;
                container.querySelector('.complete-phase-btn').addEventListener('click', e => {
                    const outputEl = container.querySelector('.completion-output');
                    const prompt = `V·ªõi vai tr√≤ l√† m·ªôt ng∆∞·ªùi b·∫°n ƒë·ªìng h√†nh v√† c·ªë v·∫•n h·ªçc t·∫≠p AI, h√£y vi·∫øt m·ªôt l·ªùi ƒë·ªông vi√™n, kh√≠ch l·ªá cho m·ªôt h·ªçc sinh v·ª´a ho√†n th√†nh "${phaseName}" trong l·ªô tr√¨nh l·∫•y l·∫°i g·ªëc To√°n.`;
                    callGemini(prompt, outputEl, {});
                });
            }

            // --- RENDER INITIAL UI ---
            const renderContainer = (containerId, data) => {
                const container = document.getElementById(containerId);
                data.forEach(item => container.appendChild(createTopicItem(item)));
            };
            
            renderContainer('phase1-topics', data.phase1Topics);
            renderContainer('phase2-topics', data.phase2Topics);
            renderContainer('phase3-topics', data.phase3Topics);
            
            createCompletionSection(1, 'Giai ƒëo·∫°n 1: N·ªÅn t·∫£ng');
            createCompletionSection(2, 'Giai ƒëo·∫°n 2: Tr·ªçng t√¢m 12');
            createCompletionSection(3, 'Giai ƒëo·∫°n 3: TƒÉng t·ªëc');

            const strategyContainer = document.getElementById('strategy-items');
            data.strategyItems.sort((a, b) => a.specialFeature ? -1 : 1)
                               .forEach(item => strategyContainer.appendChild(createStrategyItem(item)));

            document.getElementById('personal-planner-btn').addEventListener('click', e => {
                const topics = document.getElementById('weak-topics-input').value;
                const time = document.getElementById('daily-time-input').value;
                const outputEl = document.getElementById('personal-planner-output');
                if (!topics.trim() || !time.trim()) {
                    outputEl.innerHTML = `<p class="text-sm text-yellow-600 mt-3">Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.</p>`;
                    return;
                }
                const prompt = `V·ªõi vai tr√≤ l√† m·ªôt c·ªë v·∫•n h·ªçc t·∫≠p AI, h√£y t·∫°o m·ªôt l·ªãch tr√¨nh h·ªçc t·∫≠p c√° nh√¢n h√≥a trong 4 tu·∫ßn cho h·ªçc sinh c·ªßng c·ªë ki·∫øn th·ª©c To√°n. C√°c ch·ªß ƒë·ªÅ y·∫øu: "${topics}". Th·ªùi gian h·ªçc m·ªói ng√†y: "${time}".`;
                callGemini(prompt, outputEl, {});
            });

            // --- CHART.JS SETUP ---
            const ctx = document.getElementById('exam-chart').getContext('2d');
            const chartConfig = { type: 'doughnut', data: { labels: data.examTopics.labels, datasets: [{ label: 'S·ªë c√¢u', data: data.examTopics.data, backgroundColor: ['rgba(255, 99, 132, 0.7)','rgba(54, 162, 235, 0.7)','rgba(255, 206, 86, 0.7)','rgba(75, 192, 192, 0.7)','rgba(153, 102, 255, 0.7)','rgba(255, 159, 64, 0.7)','rgba(46, 204, 113, 0.7)','rgba(231, 76, 60, 0.7)','rgba(149, 165, 166, 0.7)'], borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Ph√¢n b·ªï c√¢u h·ªèi theo Chuy√™n ƒë·ªÅ', font: { size: 16 } }, tooltip: { callbacks: { label: c => `${c.label||''}: ${c.parsed||0} c√¢u` } } } } };
            const examChart = new Chart(ctx, chartConfig);
            document.getElementById('toggle-chart-view').addEventListener('click', e => {
                const isTopicsView = examChart.options.plugins.title.text.includes('Chuy√™n ƒë·ªÅ');
                const newView = isTopicsView ? 'difficulty' : 'topics';
                const chartDataKey = `exam${newView.charAt(0).toUpperCase() + newView.slice(1)}`;
                examChart.data.labels = data[chartDataKey].labels;
                examChart.data.datasets[0].data = data[chartDataKey].data;
                examChart.options.plugins.title.text = `Ph√¢n b·ªï c√¢u h·ªèi theo ${isTopicsView ? 'M·ª©c ƒë·ªô' : 'Chuy√™n ƒë·ªÅ'}`;
                e.target.textContent = `Xem ph√¢n b·ªï theo ${isTopicsView ? 'Chuy√™n ƒë·ªÅ' : 'M·ª©c ƒë·ªô'}`;
                examChart.update();
            });
        });
    </script>

</body>
</html>
 TRI TH·ª®C L√Ä S·ª®C M·∫†NH: üéâGreat achievements often start with small steps - very big thing is made of small steps, small steps can lead to remarkable accomplishment and significant progress as wellüåü
